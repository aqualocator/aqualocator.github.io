<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Directory</title>
    <!-- Suppress favicon.ico 404 error -->
    <link rel="icon" href="data:,">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Ensure app fills viewport */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }
        /* Add Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 w-full">
        <h1 class="text-2xl font-bold text-gray-800">Employee Directory</h1>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Sidebar: Filters -->
        <aside class="w-full md:w-1/4 lg:w-1/5 p-6 bg-white shadow-lg overflow-y-auto">
            <div class="space-y-6">
                <!-- Search by name/responsibilities -->
                <div>
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-1">
                        Search by last/first name, responsibilities, initials
                    </label>
                    <div class="flex space-x-2">
                        <input type="text" id="search" class="flex-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2">
                        <button id="reset" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            RESET
                        </button>
                    </div>
                </div>

                <!-- Select Department -->
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                        Select Department or Engineering: Initial Search
                    </label>
                    <select id="department" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>
        </aside>

        <!-- Right Content: Employee List -->
        <main class="flex-1 overflow-y-auto p-6">
            <div id="employee-list" class="space-y-4">
                <!-- Employee cards will be populated here -->
                <p id="loading-message" class="text-gray-500">Loading employees...</p>
            </div>
        </main>
    </div>

    <!-- Modal for LOCATE button -->
    <div id="location-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-auto transform transition-all scale-95 opacity-0" id="modal-content">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-semibold text-gray-900">Cubicle Location</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Modal Body -->
            <div class="p-6 text-center" id="modal-body-content">
                <!-- Content will be injected by JS -->
                <p class="text-lg text-gray-700">Cubicle-A-101</p>
            </div>
            <!-- Modal Footer -->
            <div class="flex justify-end p-4 bg-gray-50 border-t rounded-b-lg">
                <button id="modal-close-footer-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Close
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, getDocs, query, where, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App/Firebase Config ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- PASTE YOUR MANUAL CONFIG HERE ---
        // If automatic linking fails, paste your Firebase config object below.
        // Go to Project Settings > General > Your apps > Web app > Config
        const MANUAL_FIREBASE_CONFIG = {
             apiKey: "AIzaSyABeCFheLuS08mxfWjCSS2ugXFbLDgnpIE",
             authDomain: "aqualocator-23714.firebaseapp.com",
             projectId: "aqualocator-23714",
             storageBucket: "aqualocator-23714.firebasestorage.app",
             messagingSenderId: "654848563347",
             appId: "1:654848563347:web:4702a6f55ccbf7d5edd566",
             measurementId: "G-5R7XGHVDNH"
        };
        // ------------------------------------

        // Use manual config if provided, otherwise try automatic config
        // Refactored to use if/else to avoid potential ternary operator parsing error
        let firebaseConfig;
        if (Object.keys(MANUAL_FIREBASE_CONFIG).length > 0) {
            firebaseConfig = MANUAL_FIREBASE_CONFIG;
        } else {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        }
            
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- 1. DATA TO UPLOAD ---
        // This is the data for the one-time bulk upload.
        // Fill this array with your employee data.
        const employeesToUpload = [
            {
        "name": "Edward Wright",
        "title": "Procurement/Manufacturing Support Engineer",
        "ext": "4407",
        "dept": "Eng - Mechanical",
        "email": "EWright@aqua-aerobic.com",
        "imageUrl": "datasheet_emps_row268_photo.fd2d8fb1.png",
        "initials": "EAW",

        "responsibilities": "",
        "url": "src=\"https://aquaaerobicsystem.github.io/aquadirectory/index.html?app=aquadirectory&cubicle=94\""
    }

            // ... Add all your other employees here
        ];

        // --- 2. UPLOAD FUNCTION (Run this from console) ---
        // This function uploads the data from `employeesToUpload` to Firestore.
        async function uploadAllEmployees(db) {
            if (!db) {
                console.error("Database is not initialized. Cannot upload.");
                alert("Database is not initialized. Cannot upload.");
                return;
            }

            // Path to your *public* employees collection
            const collectionPath = `artifacts/${appId}/public/data/employees`;
            const employeesCollection = collection(db, collectionPath);
            
            // Check if collection is empty before uploading
            const q = query(employeesCollection, where("name", "!=", ""));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                console.log("Database already contains employees. Upload skipped to prevent duplicates.");
                alert("Database already contains employees. Upload skipped to prevent duplicates.");
                return;
            }

            console.log("Uploading employees to Firestore...");
            let count = 0;
            for (const employee of employeesToUpload) {
                try {
                    await addDoc(employeesCollection, employee);
                    count++;
                } catch (error) {
                    console.error("Error adding document: ", error.message, employee);
                }
            }
            console.log(`Successfully uploaded ${count} employees.`);
            alert(`SUCCESS! Successfully uploaded ${count} employees.`);
        }
        // Expose upload function to window for console access
        window.uploadAllEmployees = uploadAllEmployees;


        // --- 3. GLOBAL VARIABLES ---
        let allEmployees = [];
        let db, auth;
        const imageBaseUrl = "https://aqualocator.github.io/static/media/datasheet_emps/";

        const departments = [
            "All Departments",
            "Engineering Departments - Initials!",
            "All Engineering Departments",
            "Accounting/Finance",
            "Administration",
            "AfterMarket Sales",
            "Applications Engineering",
            "Contract Administration",
            "Customer Service",
            "Domestic Sales-Midwest",
            "Domestic Sales-Northeast",
            "Domestic Sales-Southest",
            "Domestic Sales-West",
            "Eng - Admin",
            "Eng - Electrical",
            "Eng - Estimating",
            "Eng - Mechanical",
            "Eng - Standards",
            "All Engineers",
            "Field Services",
            "Human Resources",
            "Industrial Sales",
            "Information Technology",
            "International Sales",
            "Manufacturing",
            "Marketing/PR",
            "Operations",
            "Prod Mgmt - Aeration/Mixing",
            "Prod Mgmt - Bio/Membrane",
            "Prod Mgmt - Filtration",
            "Production Control",
            "Project Management",
            "Research & Development",
            "Sales and Marketing"
        ];

        // --- 4. DOM ELEMENTS ---
        const searchInput = document.getElementById('search');
        const departmentSelect = document.getElementById('department');
        const employeeList = document.getElementById('employee-list');
        const loadingMessage = document.getElementById('loading-message');
        const resetButton = document.getElementById('reset');
        
        // Modal elements
        const modal = document.getElementById('location-modal');
        const modalContent = document.getElementById('modal-content');
        const modalBody = document.getElementById('modal-body-content');
        const closeBtn = document.getElementById('modal-close-btn');
        const closeFooterBtn = document.getElementById('modal-close-footer-btn');

        // --- 5. MODAL FUNCTIONS ---
        
        /**
         * Displays the modal with specific content.
         * @param {string} content - The string to display. Can be text or a URL to an image.
         */
        function showLocation(content) {
            if (!content) {
                modalBody.innerHTML = '<p class="text-lg text-gray-700">No location data provided.</p>';
            } else if (content.match(/\.(jpeg|jpg|gif|png)$/i) != null) {
                // It's an image
                modalBody.innerHTML = `<img src="${content}" alt="Location Map" class="w-full h-auto rounded-md">`;
            } else {
                // It's text
                modalBody.innerHTML = `<p class="text-lg text-gray-700 font-medium">${content}</p>`;
            }
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
                modalContent.classList.remove('opacity-0');
                modalContent.classList.add('opacity-100');
            }, 10); // small delay to allow CSS to catch up
        }
        
        // Make showLocation globally accessible
        window.showLocation = showLocation;

        /**
         * Hides the modal window.
         */
        function hideModal() {
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            modalContent.classList.remove('opacity-100');
            modalContent.classList.add('opacity-0');
            modal.classList.remove('opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Wait for animation to finish
        }

        // --- 6. CORE APP FUNCTIONS ---

        /**
         * Populates the department dropdown list.
         */
        function populateDepartments() {
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
            // Set default selection
            departmentSelect.value = "Engineering Departments - Initials!";
        }

        /**
         * Renders the list of employees to the DOM.
         * @param {Array} employees - The array of employee objects to render.
         */
        function renderEmployees(employees) {
            employeeList.innerHTML = ''; // Clear existing list
            
            if (employees.length === 0) {
                employeeList.innerHTML = '<p class="text-gray-500">No employees found matching your criteria.</p>';
                return;
            }

            employees.forEach(emp => {
                const empCard = document.createElement('div');
                empCard.className = 'flex items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200';
                
                // Construct full image URL
                const fullImageUrl = emp.imageUrl ? `${imageBaseUrl}${emp.imageUrl}` : `https://placehold.co/100x100/e2e8f0/cbd5e0?text=${emp.initials || '??'}`;

                // This is the fix: The onclick handler should be a string that
                // *calls* showLocation with the *content* of emp.url.
                // We must be careful to properly escape the string.
                // If emp.url itself contains quotes, this could be tricky, but
                // assuming it's simple like "Cubicle-A-101" or an image URL, this is fine.
                
                // Let's make it safer by attaching the event listener in JS
                const locateButton = document.createElement('button');
                locateButton.className = 'ml-auto px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-gray-700';
                locateButton.textContent = 'LOCATE';
                
                // Add the click listener
                locateButton.addEventListener('click', () => {
                    // We assume emp.url is the *content* to show
                    // e.g., "Cubicle-A-101" or "https://path/to/image.jpg"
                    if(emp.url) {
                        showLocation(emp.url);
                    } else {
                        showLocation('No location data for this user.');
                    }
                });


                empCard.innerHTML = `
                    <img src="${fullImageUrl}" alt="Photo of ${emp.name}" class="w-20 h-20 rounded-full object-cover mr-4" onerror="this.src='https://placehold.co/100x100/e2e8f0/cbd5e0?text=${emp.initials || '??'}'; this.onerror=null;">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-blue-800">${emp.name}</h3>
                        <p class="text-sm text-gray-700">${emp.title || 'N/A'}</p>
                        <p class="text-sm text-gray-500"><strong>Initials:</strong> ${emp.initials || 'N/A'}</p>
                        <p class="text-sm text-gray-500"><strong>Ext:</strong> ${emp.ext || 'N/A'}</p>
                        <p class="text-sm text-gray-500"><strong>Dept:</strong> ${emp.dept || 'N/A'}</p>
                        <p class="text-sm text-gray-500"><strong>Responsibilities:</strong> ${emp.responsibilities || 'N/A'}</p>
                        <a href="mailto:${emp.email}" class="text-sm text-blue-600 hover:underline">${emp.email || 'No email'}</a>
                    </div>
                `;
                
                // Append the button we created in JS
                empCard.appendChild(locateButton);
                
                employeeList.appendChild(empCard);
            });
        }

        /**
         * Filters and re-renders the employee list based on current inputs.
         */
        function filterAndRender() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedDept = departmentSelect.value;

            const filteredEmployees = allEmployees.filter(emp => {
                // Check department
                let deptMatch = false;
                if (selectedDept === "All Departments") {
                    deptMatch = true;
                } else if (selectedDept === "All Engineering Departments") {
                    deptMatch = emp.dept && emp.dept.toLowerCase().startsWith('eng -');
                } else if (selectedDept === "Engineering Departments - Initials!") {
                     // This is the default, show all for this specific value
                    deptMatch = true;
                } else {
                    deptMatch = emp.dept === selectedDept;
                }

                // Check search term
                let searchMatch = false;
                if (searchTerm === "") {
                    searchMatch = true;
                } else {
                    searchMatch = (
                        (emp.name && emp.name.toLowerCase().includes(searchTerm)) ||
                        (emp.responsibilities && emp.responsibilities.toLowerCase().includes(searchTerm)) ||
                        (emp.initials && emp.initials.toLowerCase().includes(searchTerm)) ||
                        // Allow searching by last name
                        (emp.name && emp.name.split(' ').some(part => part.toLowerCase().includes(searchTerm)))
                    );
                }

                return deptMatch && searchMatch;
            });

            renderEmployees(filteredEmployees);
        }

        /**
         * Resets all filters to their default state.
         */
        function resetFilters() {
            searchInput.value = '';
            departmentSelect.value = 'Engineering Departments - Initials!'; // Default
            filterAndRender();
        }

        /**
         * Initializes Firebase and sets up authentication.
         * @returns {Promise<{db: Firestore, auth: Auth}>}
         */
        async function initializeFirebaseApp() {
            // Enable detailed logging for debugging
            setLogLevel('Debug');

            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                console.error("Firebase configuration is missing. Please paste it into MANUAL_FIREBASE_CONFIG.");
                loadingMessage.textContent = "Error: Firebase configuration is missing. Cannot load app.";
                throw new Error("Firebase configuration is missing.");
            }

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                
                console.log("Firebase app initialized. Authenticating...");

                // Sign in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                console.log("Firebase setup complete. User ID:", auth.currentUser?.uid);
                // Make db and auth accessible to the upload function
                window.uploadAllEmployees = () => uploadAllEmployees(db);
                
                return { db, auth };

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingMessage.textContent = `Error connecting to Firebase: ${error.message}`;
                // Log the config to check, but hide sensitive keys
                const safeConfig = { ...firebaseConfig, apiKey: "REDACTED" };
                console.log("Config used:", JSON.stringify(safeConfig));
                throw error;
            }
        }

        /**
         * Fetches employees from Firestore and sets up a real-time listener.
         * @param {Firestore} db - The Firestore database instance.
         */
        function fetchEmployees(db) {
            const collectionPath = `artifacts/${appId}/public/data/employees`;
            const employeesCollection = collection(db, collectionPath);
            
            console.log(`Setting up listener on: ${collectionPath}`);

            onSnapshot(employeesCollection, (snapshot) => {
                console.log(`Received ${snapshot.size} employee documents.`);
                allEmployees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort employees by name by default
                allEmployees.sort((a, b) => a.name.localeCompare(b.name));
                
                loadingMessage.style.display = 'none';
                filterAndRender(); // Initial render
                
                if (snapshot.empty) {
                     loadingMessage.style.display = 'block';
                     loadingMessage.innerHTML = `
                        No employees found in the database. <br>
                        1. Make sure your data is in: <strong class="text-sm">${collectionPath}</strong> <br>
                        2. Or, run <strong class="text-sm">uploadAllEmployees()</strong> in the console to upload test data.`;
                }
                
            }, (error) => {
                console.error("Error fetching employees: ", error);
                loadingMessage.textContent = `Error fetching employees: ${error.message}`;
            });
        }

        /**
         * Main application entry point.
         */
        async function main() {
            populateDepartments();

            // Set up event listeners
            searchInput.addEventListener('input', filterAndRender);
            departmentSelect.addEventListener('change', filterAndRender);
            resetButton.addEventListener('click', resetFilters);
            
            // Modal close listeners
            closeBtn.addEventListener('click', hideModal);
            closeFooterBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => {
                // Close if backdrop is clicked
                if (e.target === modal) {
                    hideModal();
                }
            });

            try {
                // Initialize Firebase
                const { db: firestoreDb, auth: firebaseAuth } = await initializeFirebaseApp();
                db = firestoreDb; // Store in global
                auth = firebaseAuth; // Store in global
                
                // Fetch employees
                fetchEmployees(db);

            } catch (error) {
                console.error("Failed to initialize app.", error);
            }
        }

        // --- 7. RUN APP ---
        // Run the main function when the DOM is loaded
        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>
